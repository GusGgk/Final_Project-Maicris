<!-- ======================================================
üìÑ listar_cursos.html
P√°gina para exibir todos os cursos com op√ß√µes de a√ß√£o
========================================================= -->

<!DOCTYPE html>
<html lang="pt">
<head>
  <!-- ==================== METADADOS E ESTILOS ==================== -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lista de Cursos</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/listar_cursos.css">
</head>

<body>
  <!-- ==================== LOGO E T√çTULO ==================== -->
  <div class="logo-container">
    <img src="./img/Logo_PypyCris.jpg" alt="logo">
    <div class="logo-text">Pypy.Cris</div>
  </div>
  
  <h2>Lista de Cursos Cadastrados</h2>

  <!-- ==================== BOT√ÉO DE VOLTAR ==================== -->
  <button onclick="window.location.href='menu.html'">Voltar ao menu</button>
  <br>

  <!-- ==================== CONTAINER DE CURSOS ==================== -->
  <div id="listaCursos" class="cursos-container"></div>
  <p id="mensagem"></p>

  <!-- ==================== SCRIPT DE LISTAGEM E A√á√ïES ==================== -->
  <script>
    const lista = document.getElementById("listaCursos");
    const mensagem = document.getElementById("mensagem");

    const token = localStorage.getItem("token");
    const userType = localStorage.getItem("user_type");

    // -------------------- CARREGAR CURSOS --------------------
    async function carregarCursos() {
      try {
        const resposta = await fetch("http://localhost:5000/cursos/");
        const cursos = await resposta.json();

        const userId = localStorage.getItem("user_id");

        if (cursos.length === 0) {
          mensagem.textContent = "Nenhum curso cadastrado";
          return;
        }

        cursos.forEach(curso => {
          const card = document.createElement("div");
          card.className = "curso-card";

          let botoesAdicionais = "";
          const isInstrutorDoCurso = curso.instructor_id === userId;
          const isAdmin = userType === "admin";

          // Aluno pode se matricular
          if (userType === "aluno") {
            botoesAdicionais += `
              <button class="btn-matricular" onclick="matricular('${curso.id}', this)">
                Matricular-se
              </button>
            `;
          }

          // Instrutor dono ou admin podem editar
          if ((userType === "instrutor" || isAdmin) && isInstrutorDoCurso) {
            botoesAdicionais += `
              <button class="btn-editar" onclick="editarCurso('${curso.id}')">Editar</button>
            `;
          }

          // Apenas admin ou instrutor dono podem excluir
          if ((userType === "instrutor" && isInstrutorDoCurso) || isAdmin) {
            botoesAdicionais += `
              <button class="btn-excluir" onclick="excluirCurso('${curso.id}')">Excluir</button>
            `;
          }

          // Renderiza card
          card.innerHTML = `
            <div class="curso-header">
              <h3>${curso.title || 'Sem t√≠tulo'}</h3>
              <img src="http://localhost:5000/static/img/cursos/${curso.image || 'default.png'}" class="curso-img">
              <span class="curso-linguagem">${curso.language || 'N/A'}</span>
            </div>
            <div class="curso-detalhes">
              <p><strong>Descri√ß√£o:</strong> ${curso.description || 'Sem descri√ß√£o'}</p>
              <p><strong>N√≠vel:</strong> <span class="nivel ${curso.level?.toLowerCase() || 'iniciante'}">${curso.level || 'Iniciante'}</span></p>
              <p><strong>Dura√ß√£o:</strong> ${curso.duration || 0} horas</p>
              <p><strong>Pre√ßo:</strong> R$ ${parseFloat(curso.price || 0).toFixed(2)}</p>
              <p><strong>Instrutor:</strong> ${curso.instructor_id || 'N√£o especificado'}</p>
              ${botoesAdicionais}
            </div>
          `;

          lista.appendChild(card);
        });
      } catch (erro) {
        mensagem.textContent = "Erro ao buscar cursos";
        console.error("Erro:", erro);
      }
    }

    // -------------------- FUN√á√ÉO PARA MATRICULAR --------------------
    async function matricular(courseId, buttonEl) {
      const token = localStorage.getItem("token");

      if (!token) {
        alert("Voc√™ precisa estar logado como aluno para se matricular.");
        return;
      }

      if (!confirm("Deseja realmente se matricular neste curso?")) return;

      try {
        const res = await fetch("http://localhost:5000/enrollments/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ course_id: courseId })
        });

        const resultado = await res.json();

        if (res.ok) {
          buttonEl.disabled = true;
          buttonEl.textContent = "Inscrito ‚úÖ";
          buttonEl.style.background = "#4cc9f0";
        } else {
          alert(resultado.mensagem || "Erro ao se matricular.");
        }
      } catch (erro) {
        console.error("Erro ao enviar matr√≠cula:", erro);
        alert("Erro ao se conectar com o servidor.");
      }
    }

    // -------------------- FUN√á√ÉO PARA EXCLUIR CURSO --------------------
    async function excluirCurso(courseId) {
      const token = localStorage.getItem("token");
      const userType = localStorage.getItem("user_type");

      let confirmacao = true;
      let motivo = "";

      if (userType === "admin") {
        motivo = prompt("Digite o motivo da exclus√£o:");
        if (!motivo) {
          alert("Opera√ß√£o cancelada.");
          return;
        }
      } else {
        confirmacao = confirm("Tem certeza que deseja excluir seu curso?");
        if (!confirmacao) return;
      }

      try {
        const resposta = await fetch(`http://localhost:5000/cursos/${courseId}`, {
          method: "DELETE",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: userType === "admin" ? JSON.stringify({ motivo }) : null
        });

        const resultado = await resposta.json();

        if (resposta.ok) {
          alert("Curso exclu√≠do com sucesso!");
          window.location.reload();
        } else {
          alert(resultado.mensagem || "Erro ao excluir o curso.");
        }
      } catch (erro) {
        alert("Erro de conex√£o com o servidor.");
        console.error("Erro ao excluir curso:", erro);
      }
    }

    // -------------------- REDIRECIONA PARA EDI√á√ÉO --------------------
    function editarCurso(id) {
      window.location.href = `editar_curso.html?id=${id}`;
    }

    // -------------------- INICIAR AO CARREGAR P√ÅGINA --------------------
    document.addEventListener("DOMContentLoaded", carregarCursos);
  </script>
</body>
</html>
