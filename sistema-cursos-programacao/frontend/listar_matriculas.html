<!-- ======================================================
üìÑ listar_matriculas.html
P√°gina que exibe as matr√≠culas do aluno logado
========================================================= -->

<!DOCTYPE html>
<html lang="pt-br">
<head>
  <!-- ==================== METADADOS E ESTILO ==================== -->
  <meta charset="UTF-8">
  <title>Minhas Matr√≠culas - Pypy.Cris</title>
  <link rel="stylesheet" href="css/listar_matriculas.css">
</head>

<body>
  <!-- ==================== LOGO E T√çTULO ==================== -->
  <div class="logo-container">
    <img src="./img/Logo_PypyCris.jpg" alt="logo">
    <div class="logo-text">Pypy.Cris</div>
  </div>

  <h2>Minhas Matr√≠culas</h2>

  <!-- ==================== CONTAINER DE MATR√çCULAS ==================== -->
  <div id="matriculasContainer" class="matriculas-container"></div>
  <p id="mensagem"></p>

  <button onclick="window.location.href='menu.html'">Voltar ao menu</button>

  <!-- ==================== SCRIPT DE CARREGAMENTO E A√á√ÉO ==================== -->
  <script>
    const token = localStorage.getItem("token");
    const userId = localStorage.getItem("user_id");
    const container = document.getElementById("matriculasContainer");
    const mensagem = document.getElementById("mensagem");

    // -------------------- VERIFICA SE O USU√ÅRIO EST√Å LOGADO --------------------
    if (!token || !userId) {
      alert("Voc√™ precisa estar logado para ver suas matr√≠culas.");
      window.location.href = "login.html";
    }

    // -------------------- FUN√á√ÉO PARA CARREGAR MATR√çCULAS --------------------
    async function carregarMatriculas() {
      try {
        const resposta = await fetch(`http://localhost:5000/enrollments/user/${userId}`, {
          headers: {
            "Authorization": `Bearer ${token}`
          }
        });

        const dados = await resposta.json();

        if (!resposta.ok || dados.length === 0) {
          mensagem.textContent = "Nenhuma matr√≠cula encontrada.";
          return;
        }

        for (const [index, matricula] of dados.entries()) {
          const card = document.createElement("div");
          card.className = "matricula-card";
          card.style.setProperty("--index", index);

          // Busca o t√≠tulo do curso baseado no course_id
          let courseTitle = "Carregando...";
          try {
            const cursoRes = await fetch(`http://localhost:5000/cursos/${matricula.course_id}`);
            const curso = await cursoRes.json();
            courseTitle = curso.title || "Curso n√£o encontrado";
          } catch (err) {
            console.error("Erro ao buscar curso:", err);
            courseTitle = "Erro ao carregar curso";
          }

          // Renderiza a matr√≠cula
          card.innerHTML = `
            <p><strong>ID da Matr√≠cula:</strong> ${matricula.id}</p>
            <p><strong>Curso:</strong> ${courseTitle}</p>
            <p><strong>Data da Matr√≠cula:</strong> ${new Date(matricula.enrollment_date).toLocaleString()}</p>
            <button onclick="acessarConteudo(${matricula.course_id})" class="btn-acessar">Acessar Conte√∫do</button>
          `;

          container.appendChild(card);
        };
      } catch (erro) {
        mensagem.textContent = "Erro ao carregar matr√≠culas.";
        console.error("Erro:", erro);
      }
    }

    // -------------------- REDIRECIONAR PARA CONTE√öDO DO CURSO --------------------
    function acessarConteudo(courseId) {
      window.location.href = `visualizar_conteudo.html?course_id=${courseId}`;
    }

    // -------------------- INICIAR CARREGAMENTO --------------------
    document.addEventListener("DOMContentLoaded", carregarMatriculas);
  </script>
</body>
</html>
